<chat>
  <style scoped>
    .direct-chat-text {
      cursor: pointer;
    }
    .direct-chat-text i.right {
      float: right;
      line-height: 20px;
    }

    .direct-chat-text i.left {
      line-height: 20px;
      margin-right: 10px;
    }

  </style>
  <section class="content-header">
    <h1>
      &nbsp;
     <!--  <small>可查所有用户列表</small> -->
    </h1>
    <ol class="breadcrumb">
      <li><a href="#"><i class="fa fa-dashboard"></i> 主页</a></li>
      <li class="active">聊天</li>
    </ol>
  </section>
  <section class="content">
    <div class="box box-success direct-chat direct-chat-success">
        <div class="box-header with-border">
          <h3 class="box-title">您正在与尔朵进行交谈</h3>
        </div>
        <div class="box-body" style="min-height: {riot.config.panelHeight - 100}px;">
          <div id="box" class="direct-chat-messages" style="height: 100%;">
            <div class="direct-chat-msg {type == 'user' ? 'right' : 'left'}" each={messages}>
              <div class="direct-chat-info clearfix">
                <span class="direct-chat-name pull-{type == 'user' ? 'right' : 'left'}">
                  {type == 'user' ? (user.nickName || user.username) : '尔朵'}
                </span>
                <span class="direct-chat-timestamp pull-{type == 'user' ? 'left' : 'right'}">{new Date().format()}</span>
              </div>
              <img class="direct-chat-img" src="/assets/vendors/adminlte/img/{type == 'user' ? 'user2-160x160.jpg' : 'er-duo-01.jpg'}">
              <div class="direct-chat-text" onclick={play}>
                <span><i class="fa fa-play left"></i>{content}</span>
              </div>
            </div>
          </div>
        </div>
        <!-- /.box-body -->
        <div class="box-footer">
          <div class="input-group">
            <input type="text" name="message" placeholder="输入交谈内容..." class="form-control" onkeypress={send}>
                <span class="input-group-btn">
                  <button type="button" class="btn btn-success btn-flat"  onclick={send}>发送</button>
                </span>
          </div>
        </div>
        <!-- /.box-footer-->
      </div>
  </section>

  <script>
    var _this = this;
    this.user = riot.data.user;

    Date.prototype.format = function(fmt) {
      if(fmt==null){
        fmt = "yyyy-MM-dd hh:mm:ss";
      }

      var o = {   
        "M+" : this.getMonth()+1,                 //月份   
        "d+" : this.getDate(),                    //日   
        "h+" : this.getHours(),                   //小时   
        "m+" : this.getMinutes(),                 //分   
        "s+" : this.getSeconds(),                 //秒   
        "q+" : Math.floor((this.getMonth()+3)/3), //季度   
        "S"  : this.getMilliseconds()             //毫秒   
      };   
      if(/(y+)/.test(fmt))   
        fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));   
      for(var k in o)   
        if(new RegExp("("+ k +")").test(fmt))   
      fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));   
      return fmt;   
    };

    var cache = sessionStorage.getItem('messages');
    this.messages = cache ? JSON.parse(cache) : [{type: 'system', content: '你好，我是尔朵！'}];
    addMessage(type, content) {
      this.messages.push({
        type: type,
        content: content
      });
      sessionStorage.setItem('messages', JSON.stringify(this.messages));
    }

    send(e) {
      if (!this.message.value) {
        return true;
      }

      if ((e instanceof KeyboardEvent && e.which == 13) || e instanceof MouseEvent) {
        _this.addMessage('user', this.message.value);
        $.ajax({
          url: riot.config.apiPrefix + 'knowledge/dialog/ask/' + this.message.value,
          type: 'post'
        }).done(function(data) {
          _this.addMessage('system', data.result);
          _this.update();
        })
        this.message.value = '';
        this.update();
      }
      return true;
    }

    /**
      * 初始化Session对象
      */
      var session = new IFlyTtsSession({
        'url' : 'http://webapi.openspeech.cn/',
        'interval' : '30000',
        'disconnect_hint' : 'disconnect',
        'sub' : 'tts'
      });
      var audio = null;

    /**
      * 输入文本，输出语音播放链接
      * @content 待合成文本(不超过4096字节)
      */
    play(e) {
        /***********************************************************以下签名过程需根据实际应用信息填入***************************************************/

        var appid = "56667486";                              //应用APPID，在open.voicecloud.cn上申请即可获得
        var timestamp = new Date().toLocaleTimeString();                      //当前时间戳，例new Date().toLocaleTimeString()
            var expires = 60000;                          //签名失效时间，单位:ms，例60000
        //!!!为避免secretkey泄露，签名函数调用代码建议在服务器上完成
        var signature = faultylabs.MD5(appid + '&' + timestamp + '&' + expires + '&' + "0be1c7f08f6a1bc0");
       /************************************************************以上签名过程需根据实际应用信息填入**************************************************/

      /**
      * xiaoyan(青年女声,普通话) xiaoyu(青年男声,普通话) Catherine(英文女声)
      * henry(英文男声) vixy(小燕,普通话) vixm(小梅,粤语) vixl(小莉,台湾普通话)
      * vixr(小蓉,四川话) vixyun(小芸,东北话)
      */
      if (e.item.type == 'system') {
        vcn = 'vixl';
      }else {
        vcn = 'xiaoyu';
      }

      var params = { "params" : "aue = speex-wb;7, ent = intp65, spd = 50, vol = 50, tte = utf8, caller.appid=" + appid + ",timestamp=" + timestamp + ",expires=" + expires + ",vcn=" + vcn, "signature" : signature, "gat" : "mp3"};
      session.start(params, e.item.content, function (err, obj)
          {
          if(err) {
            alert("语音合成发生错误，错误代码 ：" + err);
          } else {
              if(audio != null)
          {
              audio.pause();
          }
          audio = new Audio();
          audio.src = '';
          audio.play();
          audio.src = "http://webapi.openspeech.cn/" + obj.audio_url;
          audio.play();
          }
        });
    };

    
  </script>
</chat>
