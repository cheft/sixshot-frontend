<inline-grid>
  <div class="box box-{opts.theme} box-solid">
    <div class="box-header">
      <h3 class="box-title">{opts.title}</h3>
      <div class="box-tools" if={!opts.readonly}>
        <a href="javascript:;" class="btn btn-xs bg-purple" onclick={startEdit}><i class="fa fa-edit"></i> 开启编辑</a>
      </div>
    </div>
    <div class="box-body no-padding">
      <table class="table table-striped">
        <tbody>
          <tr>
            <th style="width: 10px">#</th>
            <th>内容</th>
            <th if={!opts.readonly && !editing} style="width: 50px">操作</th>
          </tr>
          <tr each={l, i in list}>
            <td if={!editing}>{i + 1}</td>
            <td if={editing} style="line-height: 32px;">{i + 1}</td>
            <td>
              <span if={!editing}>{l.content}</span>
              <input if={editing} type="text" class="js-item form-control" value={l.content}>
            </td>
            <td if={!parent.opts.readonly && !editing} ><span class="btn badge bg-red" onclick={del}>删除</span></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="box-footer" if={!opts.readonly}>
      <div if={!editing} class="input-group">
        <input type="text" class="form-control" name="newitem" placeholder="输入{text}并添加到列表" onkeypress={add}>
        <div class="input-group-addon btn" onclick={add}>
          <i class="fa fa-plus"></i>
        </div>
      </div>
      <div if={editing}>
        <button type="button" class="btn btn-primary" onclick={confirmEdit}>确认数据</button>
        <button type="button" class="btn btn-cancel" onclick={stopEdit}>放弃编辑</button>
      </div>
    </div>
  </div>

  <script>
    var _this = this;
    this.list = [];
    var text;
    if(this.opts.type == 'ask'){
      text = '问题';
    }else{
      text = '答案';
    }
    this.text = text;

    addItem(){
      $.ajax({
        url: riot.config.apiPrefix + 'knowledge/' + _this.opts.type + '/validate/' + _this.newitem.value,
        type: 'post',
        data: {}
      }).done(function(data) {
        if(data.result=='true'){
          console.log('问题可用');
          //TODO 遍历 list 中已经存在的情况　
          _this.list.push({content: _this.newitem.value});
          _this.update();
          _this.newitem.value = '';
        }else{
          _this.newitem.focus();

          $.notify('<strong>该' + text + '已存在：</strong>', {type: 'error'});
        }
      }).fail(function() {
        console.log('error');
      })      
    }

    add(e) {
      if ((e instanceof KeyboardEvent && e.which == 13) || e instanceof MouseEvent) {
        if (!this.newitem.value||this.newitem.value.trim()=='') {
          this.newitem.focus();
          $.notify('<strong>请输入内容！</strong>', {type: 'error', delay:50});
          return true;
        }
        this.addItem();

      }
      return true;
    }

    del(e) {
      this.list.splice(e.item.i, 1);
      this.update();
    }

    startEdit(e) {
      this.editing = true;
      this.update();
    }

    confirmEdit(e) {
      var items = this.root.querySelectorAll('.js-item');
      for (var i = 0; i < items.length; i++) {
        this.list[i] = {content: items[i].value};
      }
      this.stopEdit();
    }

    stopEdit() {
      this.editing = false;
      this.update(); 
    }
  </script>
</inline-grid>
